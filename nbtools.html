<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>私密纸条查看器</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "微软雅黑", sans-serif; }
    body { min-height: 100vh; background: #f5f7fa; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { width: 100%; max-width: 500px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 35px 25px; }
    h1 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 10px; font-weight: 600; }
    /* 新增时间提示区样式，匹配原版 */
    .time-tips { 
      text-align: center; 
      font-size: 14px; 
      margin-bottom: 20px; 
      line-height: 1.6;
    }
    .create-time { color: #666; }
    .expire-time { color: #ff4444; /* 原版红色 */ }
    /* 修复：用visibility隐藏（保留占位，避免布局塌陷），而非display:none */
    .input-group { 
      visibility: hidden; 
      height: 0; 
      margin: 0; 
      padding: 0; 
      overflow: hidden;
    }
    #keyInput { flex: 1; height: 48px; padding: 0 15px; border: 1px solid #e1e5eb; border-radius: 8px; font-size: 16px; outline: none; transition: border 0.3s; }
    #keyInput:focus { border-color: #409eff; box-shadow: 0 0 0 2px rgba(64,158,255,0.1); }
    #submitBtn { height: 48px; padding: 0 20px; background: #409eff; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
    #submitBtn:hover { background: #337ecc; }
    #submitBtn:disabled { background: #b3d4fc; cursor: not-allowed; }
    #contentArea { min-height: 120px; padding: 18px; border-radius: 8px; background: #f8fafc; border: 1px solid #e1e5eb; white-space: pre-wrap; line-height: 1.7; color: #333; font-size: 15px; }
    .error { color: #f56c6c; }
    .loading { color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NoBook 账户查询</h1>
    <!-- 新增时间提示区，匹配原版布局 -->
    <div class="time-tips" id="timeTips">
      <div class="create-time">创建时间：</div>
      <div class="expire-time">该页面将会在小时分钟后被销毁</div>
    </div>
    <div class="input-group">
      <input type="text" id="keyInput" placeholder="请输入4位提取密钥">
      <button id="submitBtn" onclick="getMemo()">确认查看</button>
    </div>
    <div id="contentArea" class="loading">请输入密钥并点击查看</div>
  </div>

  <script>
    const keyInput = document.getElementById('keyInput');
    const submitBtn = document.getElementById('submitBtn');
    const contentArea = document.getElementById('contentArea');
    const timeTips = document.getElementById('timeTips'); // 新增时间提示区DOM
    const JSONBIN_API = 'https://api.jsonbin.io/v3/b';
    const JSONBIN_KEY = '$2a$10$pk/pj9VG/nykgHoQdBLez.d/eDYOg0DfLYr4xTVop73mCl4auuA3u';

    // 全局存储binId（后台隐藏，不显示在输入框）
    let binId = '';

    // 解析短地址参数（c=key_binId）- 核心修复
    const params = new URLSearchParams(window.location.search);
    const cParam = params.get('c');
    if (cParam) {
      const [parseKey, parseBinId] = cParam.split('_');
      // 仅将4位密钥填充到输入框
      if (parseKey && parseKey.length === 4) {
        keyInput.value = parseKey;
      }
      // binId后台存储，不显示
      if (parseBinId) {
        binId = parseBinId;
      }
      // 自动查询内容
      getMemo();
    }

    // 计算剩余时间（原版表述：xx小时xx分钟后销毁）
    function calculateRemainingTime(expiredAt) {
      if (!expiredAt) return { hours: 0, minutes: 0 };
      const expireTime = new Date(expiredAt).getTime();
      const now = new Date().getTime();
      const diff = expireTime - now;
      
      if (diff <= 0) return { hours: 0, minutes: 0 }; // 已过期
      
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return { hours, minutes };
    }

    // 格式化创建时间（原版样式：YYYY-MM-DD HH:mm:ss）
    function formatCreateTime(isoTime) {
      if (!isoTime) return '未知';
      const date = new Date(isoTime);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // 更新时间提示区（移除多余空格，匹配原版样式）
    function updateTimeTips(createdAt, expiredAt) {
      const createTimeText = formatCreateTime(createdAt);
      const { hours, minutes } = calculateRemainingTime(expiredAt);
      
      // 核心修改：移除"在"和"小时"/"分钟"前的空格
      timeTips.innerHTML = `
        <div class="create-time">创建时间：${createTimeText}</div>
        <div class="expire-time">该页面将会在${hours}小时${minutes}分钟后被销毁</div>
      `;
    }

    // 获取纸条内容
    async function getMemo() {
      const inputKey = keyInput.value.trim();
      contentArea.className = '';

      // 校验4位密钥
      if (inputKey.length !== 4) {
        contentArea.className = 'error';
        contentArea.textContent = '请输入4位提取密钥！';
        return;
      }

      // 无binId则提示跳转原站
      if (!binId) {
        contentArea.className = 'error';
        contentArea.textContent = `请访问原站查看：\nhttps://n.showmsg.cn/view/${inputKey}`;
        return;
      }

      // 加载状态
      contentArea.className = 'loading';
      contentArea.textContent = '正在查询纸条...';
      submitBtn.disabled = true;
      // 重置时间提示区为加载状态（同步移除空格）
      timeTips.innerHTML = `
        <div class="create-time">创建时间：查询中...</div>
        <div class="expire-time">该页面将会在查询中...小时查询中...分钟后被销毁</div>
      `;

      try {
        // 请求JSONBIN获取内容
        const res = await fetch(`${JSONBIN_API}/${binId}/latest`, {
          headers: { 
            'X-Master-Key': JSONBIN_KEY, 
            'Content-Type': 'application/json',
            'X-Access-Key': JSONBIN_KEY
          }
        });
        
        if (!res.ok) throw new Error(`请求失败（状态码：${res.status}）`);
        const data = await res.json();
        
        // 读取对应密钥的内容
        let memoContent = '';
        const memoData = data.record[inputKey];
        if (typeof memoData === 'object' && memoData.content) {
          // 新格式 - 仅展示内容，时间移到标题区
          memoContent = memoData.content;
          // 更新标题区时间提示（核心：匹配原版样式）
          updateTimeTips(memoData.created_at, memoData.expired_at);
        } else if (typeof memoData === 'string') {
          // 旧格式（仅内容）- 时间提示区显示默认值（移除空格）
          memoContent = memoData;
          timeTips.innerHTML = `
            <div class="create-time">创建时间：未知</div>
            <div class="expire-time">该页面将会在24小时0分钟后被销毁</div>
          `;
        } else {
          // 无数据
          memoContent = '未找到纸条内容！\n1. 密钥错误 2. 纸条过期 3. 纸条已删除';
          // 重置时间提示区（移除空格）
          timeTips.innerHTML = `
            <div class="create-time">创建时间：</div>
            <div class="expire-time">该页面将会在小时分钟后被销毁</div>
          `;
        }
        contentArea.textContent = memoContent;

      } catch (err) {
        contentArea.className = 'error';
        contentArea.textContent = `请求失败：${err.message}\n可访问原站：https://n.showmsg.cn/view/${inputKey}`;
        // 错误时重置时间提示区（移除空格）
        timeTips.innerHTML = `
          <div class="create-time">创建时间：</div>
          <div class="expire-time">该页面将会在小时分钟后被销毁</div>
        `;
      } finally {
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>

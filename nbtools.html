<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看私密纸条</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .container { text-align: center; padding: 2rem; border: 1px solid #eee; border-radius: 8px; }
        #keyDisplay { font-size: 1.2rem; margin: 1rem 0; padding: 0.8rem; background: #f5f5f5; border-radius: 4px; }
        #result { margin-top: 1.5rem; padding: 1rem; border-radius: 4px; min-height: 100px; }
        .success { border: 1px solid #4CAF50; background: #f9fff9; }
        .error { border: 1px solid #f44336; background: #fff9f9; }
        button { padding: 0.8rem 2rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>查看私密纸条</h1>
        <div id="keyDisplay"></div>
        <button id="checkBtn">确认查看</button>
        <div id="result"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const passKey = urlParams.get('key');
        const keyDisplay = document.getElementById('keyDisplay');
        const checkBtn = document.getElementById('checkBtn');
        const result = document.getElementById('result');

        if (passKey) {
            keyDisplay.textContent = passKey;
        } else {
            keyDisplay.textContent = '未检测到纸条密钥，请检查访问链接';
            checkBtn.disabled = true;
        }

        checkBtn.addEventListener('click', async () => {
            checkBtn.disabled = true;
            result.className = '';
            result.textContent = '正在获取纸条内容...';

            try {
                // 改为请求Netlify代理函数
                const proxyUrl = `/.netlify/functions/memo-proxy?key=${passKey}`;
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const resData = await response.json();
                if (resData.success && resData.data) {
                    result.className = 'success';
                    result.innerHTML = resData.data.content.replace(/\n/g, '<br>');
                } else {
                    result.className = 'error';
                    result.textContent = '获取失败：' + (resData.message || '纸条不存在或已过期');
                }
            } catch (error) {
                result.className = 'error';
                result.textContent = '网络请求失败（错误原因：' + error.message + '）';
            } finally {
                checkBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§å¯†çº¸æ¡æŸ¥çœ‹å™¨</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "å¾®è½¯é›…é»‘", sans-serif; }
    body { min-height: 100vh; background: #f5f7fa; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { width: 100%; max-width: 500px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 35px 25px; }
    h1 { text-align: center; color: #2c3e50; font-size: 22px; margin-bottom: 25px; font-weight: 600; }
    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    #keyInput { flex: 1; height: 48px; padding: 0 15px; border: 1px solid #e1e5eb; border-radius: 8px; font-size: 16px; outline: none; transition: border 0.3s; }
    #keyInput:focus { border-color: #409eff; box-shadow: 0 0 0 2px rgba(64,158,255,0.1); }
    #submitBtn { height: 48px; padding: 0 20px; background: #409eff; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
    #submitBtn:hover { background: #337ecc; }
    #submitBtn:disabled { background: #b3d4fc; cursor: not-allowed; }
    #contentArea { min-height: 180px; padding: 18px; border-radius: 8px; background: #f8fafc; border: 1px solid #e1e5eb; white-space: pre-wrap; line-height: 1.7; color: #333; font-size: 15px; }
    .error { color: #f56c6c; }
    .loading { color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NoBook è´¦æˆ·æŸ¥è¯¢</h1>
    <div class="input-group">
      <input type="text" id="keyInput" placeholder="è¯·è¾“å…¥4ä½æå–å¯†é’¥">
      <button id="submitBtn" onclick="getMemo()">ç¡®è®¤æŸ¥çœ‹</button>
    </div>
    <div id="contentArea" class="loading">è¯·è¾“å…¥å¯†é’¥å¹¶ç‚¹å‡»æŸ¥çœ‹</div>
  </div>
  <script>
    const keyInput = document.getElementById('keyInput');
    const submitBtn = document.getElementById('submitBtn');
    const contentArea = document.getElementById('contentArea');
    const JSONBIN_API = 'https://api.jsonbin.io/v3/b';
    const JSONBIN_KEY = '$2a$10$pk/pj9VG/nykgHoQdBLez.d/eDYOg0DfLYr4xTVop73mCl4auuA3u';
    let binId = '';

    // è§£æçŸ­åœ°å€å‚æ•°ï¼ˆc=key_binIdï¼‰
    const params = new URLSearchParams(window.location.search);
    const cParam = params.get('c');
    if (cParam) {
      const [parseKey, parseBinId] = cParam.split('_');
      if (parseKey && parseKey.length === 4) {
        keyInput.value = parseKey;
      }
      if (parseBinId) {
        binId = parseBinId;
      }
      getMemo();
    }

    // æ—¶é—´æ ¼å¼åŒ–å·¥å…·ï¼ˆå…¼å®¹ISOæ ¼å¼ï¼‰
    function formatIsoTime(isoTime) {
      if (!isoTime) return 'æœªçŸ¥æ—¶é—´';
      const date = new Date(isoTime);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // ä¿®å¤400é”™è¯¯çš„æ ¸å¿ƒå‡½æ•°
    async function getMemo() {
      const inputKey = keyInput.value.trim();
      contentArea.className = '';

      // æ ¡éªŒ4ä½å¯†é’¥
      if (inputKey.length !== 4) {
        contentArea.className = 'error';
        contentArea.textContent = 'è¯·è¾“å…¥4ä½æå–å¯†é’¥ï¼';
        return;
      }

      // æ— binIdåˆ™æç¤ºè·³è½¬åŸç«™
      if (!binId) {
        contentArea.className = 'error';
        contentArea.textContent = `è¯·è®¿é—®åŸç«™æŸ¥çœ‹ï¼š\nhttps://n.showmsg.cn/view/${inputKey}`;
        return;
      }

      // åŠ è½½çŠ¶æ€
      contentArea.className = 'loading';
      contentArea.textContent = 'æ­£åœ¨æŸ¥è¯¢çº¸æ¡...';
      submitBtn.disabled = true;

      try {
        // ä¿®å¤ç‚¹1ï¼šç²¾ç®€è¯·æ±‚å¤´ï¼ˆç§»é™¤å†—ä½™çš„Content-Typeå’ŒX-Access-Keyï¼‰
        const res = await fetch(`${JSONBIN_API}/${binId}/latest`, {
          headers: { 
            'X-Master-Key': JSONBIN_KEY // ä»…ä¿ç•™ä¸»å¯†é’¥ï¼Œç¬¦åˆJSONBIN v3 APIè¦æ±‚
          },
          method: 'GET' // æ˜¾å¼æŒ‡å®šGETæ–¹æ³•ï¼ˆé»˜è®¤ä¹Ÿæ˜¯GETï¼Œä½†æ›´è§„èŒƒï¼‰
        });

        if (!res.ok) throw new Error(`çŠ¶æ€ç ï¼š${res.status}ï¼ˆ${res.statusText}ï¼‰`);
        const data = await res.json();
        const memoData = data.record[inputKey];

        // ä¿®å¤ç‚¹2ï¼šå…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼ï¼ˆå­—ç¬¦ä¸²/å¯¹è±¡ï¼‰
        let displayContent;
        if (typeof memoData === 'object' && memoData.content) {
          // æ–°æ ¼å¼ï¼ˆåŒ…å«æ—¶é—´å­—æ®µï¼‰
          displayContent = `ğŸ“… åˆ›å»ºæ—¶é—´ï¼š${formatIsoTime(memoData.created_at)}
âŒ› è¿‡æœŸæ—¶é—´ï¼š${formatIsoTime(memoData.expired_at)}
----------------------------------------
ğŸ“ çº¸æ¡å†…å®¹ï¼š
${memoData.content}`;
        } else if (typeof memoData === 'string' && memoData) {
          // æ—§æ ¼å¼ï¼ˆä»…å­˜å‚¨å†…å®¹å­—ç¬¦ä¸²ï¼‰
          displayContent = `ğŸ“ çº¸æ¡å†…å®¹ï¼š
${memoData}
----------------------------------------
â„¹ï¸  è¯¥çº¸æ¡æ— æ—¶é—´ä¿¡æ¯ï¼ˆæ—§ç‰ˆæœ¬åˆ›å»ºï¼‰`;
        } else {
          displayContent = 'æœªæ‰¾åˆ°çº¸æ¡å†…å®¹ï¼\n1. å¯†é’¥é”™è¯¯ 2. çº¸æ¡è¿‡æœŸ 3. çº¸æ¡å·²åˆ é™¤';
        }

        contentArea.textContent = displayContent;
      } catch (err) {
        contentArea.className = 'error';
        contentArea.textContent = `è¯·æ±‚å¤±è´¥ï¼š${err.message}\nå»ºè®®æ“ä½œï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç›´æ¥è®¿é—®åŸç«™ï¼šhttps://n.showmsg.cn/view/${inputKey}`;
      } finally {
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
